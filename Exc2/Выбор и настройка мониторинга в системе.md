## Анализ диаграммы C4 в контексте планирования мониторинга

Для внедрения мониторинга необходимо в рамках существующих компонент:
1. Определить сервисы, которые уже предоставляют метрики (если такие имеются)
2. У сервисов, которые не предоставляют метрики, реализовать сбор метрики и адаптеры для их предоставления
3. Реализовать сервис Prometheus, который через механизм Service Discovery определяет все сервисы, с которых нужно собирать метрики.
Сбор метрик осуществляется по механизму pull (взаимодействие с адаптерами сервисов).
4. Внедрить сервис мониторинга Grafana.

## Мотивация

Мониторинг позволяет оперативно реагировать на возникающие проблемы работы системы при нагрузке. Своевременное определение 
проблемных мест позволит в кратчайшие сроки решать как инциденты, возникающие у клиентов, так и предоотвращать будущие проблемы. 
Что приведет к положительному опыту взаимодействия с системой у клиентов.

## Выбор подхода к мониторингу

Описание метрик для каждого компонента системы:

### Shop API

Используемые подходы:
- RED
- USE

Список отслеживаемых метрик:
- **Number of requests (RPS) for internet shop API**  
Позволяет отслеживать внешнюю нагрузку на сервис. Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**
- **CPU % for shop API**  
Позволяет отслеживать достаточность выделенных ресурсов. Ярлыки не используются
- **Memory Utilisation for shop API**  
Позволяет отслеживать достаточность выделенных ресурсов/потенциальные утечеки памяти. Ярлыки не используются
- **Response time (latency) for shop API**  
Позволяет отслеживать насколько быстро обрабатываются пользовательские запросы. Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**
- **Number of HTTP 200 for shop API**  
В совокупности с метрикой **Number of HTTP 500 for shop API** позволяет отслеживать процент успешно выполненных запросов.
Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**
- **Number of HTTP 500 for shop API**
В совокупности с метрикой **Number of HTTP 200 for shop API** позволяет отслеживать процент успешно выполненных запросов.
Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**
- **Number of simultanious sessions for shop API**
Позволяет определить моменты пиковой нагрузки. По времени пиковой нагрузки, с помощью других метрик, можно понять как система справляется с пиковой нагрузкой. Ярлыки не используются
- **DAU/MAU**
Позволяют отслеживать рост онлайна для своевременного увеличения ресурсов системы при необходимости.

### CRM API

Используемые подходы:
- RED
- USE

Список отслеживаемых метрик:
- **Number of requests (RPS) for internet CRM API**  
  Позволяет отслеживать внешнюю нагрузку на сервис. Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**.
- **CPU % for CRM API**  
  Позволяет отслеживать достаточность выделенных ресурсов. Ярлыки не используются.
- **Memory Utilisation for CRM API**  
  Позволяет отслеживать достаточность выделенных ресурсов/потенциальные утечеки памяти. Ярлыки не используются.
- **Response time (latency) for CRM API**  
  Позволяет отслеживать насколько быстро обрабатываются пользовательские запросы. Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**.
- **Number of HTTP 200 for CRM API**  
  В совокупности с метрикой **Number of HTTP 500 for CRM API** позволяет отслеживать процент успешно выполненных запросов.
  Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**.
- **Number of HTTP 500 for CRM API**
  В совокупности с метрикой **Number of HTTP 200 for CRM API** позволяет отслеживать процент успешно выполненных запросов.
  Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**.
- **Number of simultanious sessions for CRM API**
  Позволяет определить моменты пиковой нагрузки. По времени пиковой нагрузки, с помощью других метрик, можно понять как система справляется с пиковой нагрузкой. Ярлыки не используются.
- **DAU/MAU**
  Позволяют отслеживать рост онлайна для своевременного увеличения ресурсов системы при необходимости.

### MES API

Используемые подходы:
- RED
- USE

Список отслеживаемых метрик:
- **Number of requests (RPS) for internet MES API**  
  Позволяет отслеживать внешнюю нагрузку на сервис. Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**.
- **CPU % for MES API**  
  Позволяет отслеживать достаточность выделенных ресурсов. Ярлыки не используются.
- **Memory Utilisation for MES API**  
  Позволяет отслеживать достаточность выделенных ресурсов/потенциальные утечеки памяти. Ярлыки не используются.
- **Response time (latency) for MES API**  
  Позволяет отслеживать насколько быстро обрабатываются пользовательские запросы. Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**.
- **Number of HTTP 200 for MES API**  
  В совокупности с метрикой **Number of HTTP 500 for MES API** позволяет отслеживать процент успешно выполненных запросов.
  Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**.
- **Number of HTTP 500 for MES API**
  В совокупности с метрикой **Number of HTTP 200 for MES API** позволяет отслеживать процент успешно выполненных запросов.
  Используемые ярлыки: **название REST ресурса**, **идентификатор пользователя**.
- **Number of simultanious sessions for MES API**
  Позволяет определить моменты пиковой нагрузки. По времени пиковой нагрузки, с помощью других метрик, можно понять как система справляется с пиковой нагрузкой. Ярлыки не используются.
- **DAU/MAU**
  Позволяют отслеживать рост онлайна для своевременного увеличения ресурсов системы при необходимости.

### Shop DB

Используемые подходы:
- RED
- USE

Список отслеживаемых метрик:
- **CPU % for shop db instance**  
  Позволяет отслеживать достаточность выделенных ресурсов. Ярлыки не используются.
- **Memory Utilisation for shop db instance**  
  Позволяет отслеживать достаточность выделенных ресурсов. Ярлыки не используются.
- **Query Response Time**  
  Позволяет отслеживать скорость обработки в разрезе запроса. Используемый ярлык: текст запроса (без параметров).
- **Number of connections for shop db instance**  
  Позволяет определить достаточность пула соединений/необходимость оптимизации кода, реализующего пул соединений к БД. Ярлыки не используются.
- **Size of shop db instance**  
  Позволяет определить достаточно выделенных ресурсов/аномальное разрастание размера БД. Ярлыки не используются.

### MES DB

Используемые подходы:
- RED
- USE

Список отслеживаемых метрик:
- **CPU % for MES db instance**  
  Позволяет отслеживать достаточность выделенных ресурсов. Ярлыки не используются.
- **Memory Utilisation for MES db instance**  
  Позволяет отслеживать достаточность выделенных ресурсов. Ярлыки не используются.
- **Query Response Time**  
  Позволяет отслеживать скорость обработки в разрезе запроса. Используемый ярлык: текст запроса (без параметров).
- **Number of connections for MES db instance**  
  Позволяет определить достаточность пула соединений/необходимость оптимизации кода, реализующего пул соединений к БД. Ярлыки не используются.
- **Size of MES db instance**  
  Позволяет определить достаточно выделенных ресурсов/аномальное разрастание размера БД. Ярлыки не используются.

### 3d file storage

Используемый подход: USE

Список отслеживаемых метрик:
- **Size of S3 storage**  
  Позволяет определить достаточно выделенных ресурсов/аномальное разрастание размера БД. Ярлыки не используются.

### Message Queue

Используемый подход: USE.

Список отслеживаемых метрик:
- **Number of dead-letter-exchange letters in RabbitMQ**  
Позволяет отследить сообщения, которые не были успешно обработаны клиентами. Используемый ярлык: **название очереди, из которой было первоначально вычитано сообщение**.
- **Number of message in flight in RabbitMQ**  
Позволяет определить количество сообщений находящихся в обработке в единицу времени. Используемый ярлык: **название очереди, из которой было первоначально вычитано сообщение**.

## План действий

1. Создать инстанс time-series базы данных с использованием Prometheus
2. Настроить сбор метрик для API, БД, MQ
3. Настроить дашборды для мониторинга в Grafana
4. Определить показатели насыщенности
5. Настроить оповещения о превышении показателей насыщенности